<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Letter Tracing Practice</title>
    <style>
        @font-face {
            font-family: 'TeachingPrintDotted';
            src: url('./TeachingPrintDottedLined-Ea6W8.otf') format('opentype');
            font-weight: normal;
            font-style: normal;
            font-display: swap;
        }
        
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            margin: 0;
            background-color: #f5f5f5;
            touch-action: none;
            padding: 20px;
            box-sizing: border-box;
        }
        
        .container {
            display: flex;
            flex-direction: column;
            align-items: center;
            width: 100%;
            max-width: 800px;
        }
        
        .controls {
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
        }
        
        select {
            padding: 8px 12px;
            font-size: 18px;
            border-radius: 5px;
            border: 2px solid #ddd;
        }
        
        button {
            padding: 8px 16px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        button:hover {
            background-color: #3e8e41;
        }
        
        .canvas-container {
            position: relative;
            border: 2px solid #ddd;
            background-color: white;
            border-radius: 10px;
            width: 100%;
            max-width: 500px;
            height: 500px;
            max-height: 70vh;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            touch-action: none;
        }
        
        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        
        svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        #letterCanvas {
            z-index: 1; /* Bottom layer - letter template */
        }
        
        #detectionCanvas {
            z-index: 2; /* Middle layer - invisible, used for detection */
            opacity: 0; /* Make it invisible */
            pointer-events: none; /* Don't interfere with user interaction */
        }
        
        #drawingCanvas {
            z-index: 3; /* Top layer - user drawing */
        }
        
        #tracingSvg {
            z-index: 4; /* SVG for the perfect tracing */
        }
        
        h1 {
            color: #333;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .font-loading {
            display: none; /* Hide by default */
            background-color: #fff3cd;
            border: 1px solid #ffeeba;
            color: #856404;
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            max-width: 500px;
            text-align: center;
        }
        
        /* Letter paths for each letter */
        path.letter-path {
            fill: none;
            stroke: #888;
            stroke-width: 2;
            stroke-dasharray: 5, 3;
        }
        
        path.tracing-path {
            fill: none;
            stroke: black;
            stroke-width: 6;
            stroke-linecap: round;
            stroke-linejoin: round;
            stroke-dasharray: 0;
            stroke-dashoffset: 0;
        }
        
        /* Add responsive adjustments */
        @media (max-width: 600px) {
            .canvas-container {
                height: 350px;
            }
            
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            h1 {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Letter Tracing Practice</h1>
        
        <div class="font-loading" id="fontMessage">
            The Teaching Print Dotted font is loading...
        </div>
        
        <div class="controls">
            <label for="letterSelect">Choose a letter:</label>
            <select id="letterSelect">
                <option value="a">a</option>
                <option value="b">b</option>
                <option value="c">c</option>
                <option value="d">d</option>
                <option value="e">e</option>
                <option value="f">f</option>
                <option value="g">g</option>
                <option value="h">h</option>
                <option value="i">i</option>
                <option value="j">j</option>
                <option value="k">k</option>
                <option value="l">l</option>
                <option value="m">m</option>
                <option value="n">n</option>
                <option value="o">o</option>
                <option value="p">p</option>
                <option value="q">q</option>
                <option value="r">r</option>
                <option value="s">s</option>
                <option value="t">t</option>
                <option value="u">u</option>
                <option value="v">v</option>
                <option value="w">w</option>
                <option value="x">x</option>
                <option value="y">y</option>
                <option value="z">z</option>
            </select>
            <button id="clearButton">Clear</button>
        </div>
        
        <div class="canvas-container">
            <canvas id="letterCanvas"></canvas>
            <canvas id="detectionCanvas"></canvas>
            <canvas id="drawingCanvas"></canvas>
            <svg id="tracingSvg" xmlns="http://www.w3.org/2000/svg"></svg>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const letterCanvas = document.getElementById('letterCanvas');
            const detectionCanvas = document.getElementById('detectionCanvas');
            const drawingCanvas = document.getElementById('drawingCanvas');
            const tracingSvg = document.getElementById('tracingSvg');
            const letterSelect = document.getElementById('letterSelect');
            const clearButton = document.getElementById('clearButton');
            const fontMessage = document.getElementById('fontMessage');
            
            const letterCtx = letterCanvas.getContext('2d');
            const detectionCtx = detectionCanvas.getContext('2d');
            const drawCtx = drawingCanvas.getContext('2d');
            
            // Letter paths definitions - using SVG path format
            const letterPaths = {
                a: "M 50,70 C 35,70 25,60 25,45 C 25,30 35,20 50,20 C 65,20 75,30 75,45 L 75,70 M 25,45 L 75,45",
                b: "M 30,20 L 30,70 C 30,55 40,45 55,45 C 70,45 80,55 80,62.5 C 80,70 70,80 55,80 C 40,80 30,70 30,55",
                c: "M 75,35 C 70,25 60,20 50,20 C 35,20 25,30 25,50 C 25,70 35,80 50,80 C 60,80 70,75 75,65",
                d: "M 70,20 L 70,70 C 70,55 60,45 45,45 C 30,45 20,55 20,62.5 C 20,70 30,80 45,80 C 60,80 70,70 70,55",
                e: "M 75,50 C 75,30 60,20 50,20 C 35,20 25,30 25,50 C 25,70 35,80 50,80 C 65,80 75,70 75,50 L 25,50",
                f: "M 60,25 C 60,20 55,15 45,15 C 35,15 30,20 30,30 L 30,70 M 20,40 L 50,40",
                g: "M 70,45 C 70,30 60,20 45,20 C 30,20 20,30 20,45 C 20,60 30,70 45,70 C 60,70 70,60 70,45 L 70,80 C 70,90 60,95 50,95",
                h: "M 30,20 L 30,70 M 30,45 C 30,45 40,35 55,35 C 70,35 75,45 75,50 L 75,70",
                i: "M 50,20 L 50,20 M 50,30 L 50,70",
                j: "M 60,20 L 60,20 M 60,30 L 60,75 C 60,85 50,90 45,90",
                k: "M 30,20 L 30,70 M 70,30 L 30,50 L 70,70",
                l: "M 50,20 L 50,70",
                m: "M 20,70 L 20,35 C 20,35 25,25 35,25 C 45,25 50,35 50,35 C 50,35 55,25 65,25 C 75,25 80,35 80,35 L 80,70",
                n: "M 30,70 L 30,35 C 30,35 35,25 50,25 C 65,25 70,35 70,35 L 70,70",
                o: "M 50,20 C 30,20 20,35 20,45 C 20,55 30,70 50,70 C 70,70 80,55 80,45 C 80,35 70,20 50,20",
                p: "M 30,30 L 30,90 M 30,45 C 30,45 40,35 55,35 C 70,35 80,45 80,57.5 C 80,70 70,80 55,80 C 40,80 30,70 30,70",
                q: "M 70,30 L 70,90 M 70,45 C 70,45 60,35 45,35 C 30,35 20,45 20,57.5 C 20,70 30,80 45,80 C 60,80 70,70 70,70",
                r: "M 30,70 L 30,35 C 30,35 35,25 50,25 C 65,25 70,35 70,35",
                s: "M 70,30 C 65,25 55,20 45,20 C 35,20 25,25 25,35 C 25,55 75,45 75,65 C 75,75 65,80 55,80 C 45,80 35,75 30,70",
                t: "M 50,20 L 50,60 C 50,70 55,75 65,75 M 35,40 L 65,40",
                u: "M 30,30 L 30,60 C 30,65 35,75 50,75 C 65,75 70,65 70,60 L 70,30",
                v: "M 30,30 L 50,70 L 70,30",
                w: "M 20,30 L 35,70 L 50,30 L 65,70 L 80,30",
                x: "M 30,30 L 70,70 M 70,30 L 30,70",
                y: "M 30,30 L 50,70 M 70,30 L 50,70 L 50,90 C 50,95 45,100 40,100",
                z: "M 30,30 L 70,30 L 30,70 L 70,70"
            };
            
            let activeSegmentIndex = 0;
            let currentPathSegments = [];
            let letterPathObj = null;
            let tracingPathObj = null;
            
            // Set canvas size based on container
            function resizeCanvas() {
                const container = document.querySelector('.canvas-container');
                const width = container.clientWidth;
                const height = container.clientHeight;
                
                letterCanvas.width = width;
                letterCanvas.height = height;
                detectionCanvas.width = width;
                detectionCanvas.height = height;
                drawingCanvas.width = width;
                drawingCanvas.height = height;
                
                // Clear the SVG
                tracingSvg.innerHTML = '';
                
                // Redraw the current letter when resizing
                const currentLetter = letterSelect.value;
                drawLetter(currentLetter);
            }
            
            // Initialize canvas size
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);
            
            // Draw the letter with SVG path
            function drawLetter(letter) {
                // Clear canvases and SVG
                letterCtx.clearRect(0, 0, letterCanvas.width, letterCanvas.height);
                detectionCtx.clearRect(0, 0, detectionCanvas.width, detectionCanvas.height);
                drawCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
                tracingSvg.innerHTML = '';
                
                // Reset tracing progress
                activeSegmentIndex = 0;
                
                // Get path data for the letter
                const pathData = letterPaths[letter];
                
                if (!pathData) {
                    console.error('No path data for letter:', letter);
                    return;
                }
                
                // Create the letter path in SVG
                letterPathObj = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                letterPathObj.setAttribute('d', pathData);
                letterPathObj.setAttribute('class', 'letter-path');
                tracingSvg.appendChild(letterPathObj);
                
                // Create a path for the tracing (initially invisible)
                tracingPathObj = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                tracingPathObj.setAttribute('d', pathData);
                tracingPathObj.setAttribute('class', 'tracing-path');
                tracingPathObj.setAttribute('stroke-dasharray', tracingPathObj.getTotalLength());
                tracingPathObj.setAttribute('stroke-dashoffset', tracingPathObj.getTotalLength());
                tracingSvg.appendChild(tracingPathObj);
                
                // Parse the path into segments
                parsePathIntoSegments(pathData);
                
                // Draw the letter on the detection canvas for hit testing
                // Use a thicker version for easier detection
                detectionCtx.strokeStyle = 'red';
                detectionCtx.lineWidth = 20; // Make it thick for easy detection
                detectionCtx.lineCap = 'round';
                detectionCtx.lineJoin = 'round';
                
                // Draw the path on the detection canvas
                const path = new Path2D(pathData);
                detectionCtx.stroke(path);
            }
            
            // Parse SVG path into segments for step-by-step tracing
            function parsePathIntoSegments(pathData) {
                // Split the path at 'M' commands (these indicate new subpaths)
                const mainSegments = pathData.split(/(?=[Mm])/);
                
                currentPathSegments = [];
                let totalLength = 0;
                
                // Process each main segment
                mainSegments.forEach(segment => {
                    // Create a temporary path to measure this segment
                    const tempPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                    tempPath.setAttribute('d', segment);
                    tracingSvg.appendChild(tempPath);
                    
                    const segmentLength = tempPath.getTotalLength();
                    
                    currentPathSegments.push({
                        data: segment,
                        length: segmentLength,
                        startOffset: totalLength
                    });
                    
                    totalLength += segmentLength;
                    
                    // Remove the temporary path
                    tracingSvg.removeChild(tempPath);
                });
            }
            
            // Check if a point is near the letter path
            function isPointOnPath(x, y) {
                // Get pixel data at the point
                const pixel = detectionCtx.getImageData(x, y, 1, 1).data;
                
                // If the alpha value is greater than 0, we're on the letter
                return pixel[3] > 0;
            }
            
            // Get the closest point on the current segment
            function getClosestPointOnCurrentSegment(x, y) {
                if (activeSegmentIndex >= currentPathSegments.length) {
                    return null;
                }
                
                const currentSegment = currentPathSegments[activeSegmentIndex];
                
                // Create temporary path for the current segment
                const tempPath = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                tempPath.setAttribute('d', currentSegment.data);
                tracingSvg.appendChild(tempPath);
                
                // Find closest point
                const totalLength = tempPath.getTotalLength();
                let closestPoint = null;
                let closestDistance = Infinity;
                
                // Sample points along the path to find the closest one
                const step = 5; // Sampling step size
                for (let i = 0; i <= totalLength; i += step) {
                    const pt = tempPath.getPointAtLength(i);
                    
                    // Convert SVG coordinates to canvas coordinates
                    const canvasX = pt.x / 100 * letterCanvas.width;
                    const canvasY = pt.y / 100 * letterCanvas.height;
                    
                    const distance = Math.hypot(canvasX - x, canvasY - y);
                    
                    if (distance < closestDistance) {
                        closestDistance = distance;
                        closestPoint = {
                            x: canvasX,
                            y: canvasY,
                            progress: i / totalLength
                        };
                    }
                }
                
                // Remove temporary path
                tracingSvg.removeChild(tempPath);
                
                return closestPoint;
            }
            
            // Update the tracing progress
            function updateTracingProgress(progress) {
                const totalLength = tracingPathObj.getTotalLength();
                tracingPathObj.style.strokeDashoffset = totalLength - (progress * totalLength);
            }
            
            // Start tracing interaction
            function startTracing(e) {
                const [x, y] = getCoordinates(e);
                
                // Only proceed if we're on or near the path
                if (isPointOnPath(x, y)) {
                    drawingCanvas.style.cursor = 'pointer';
                    
                    // Get closest point on current segment
                    const closestPoint = getClosestPointOnCurrentSegment(x, y);
                    
                    if (closestPoint) {
                        // Calculate overall progress based on active segment and point progress
                        let overallProgress = 0;
                        
                        // Add completed segments
                        for (let i = 0; i < activeSegmentIndex; i++) {
                            overallProgress += currentPathSegments[i].length;
                        }
                        
                        // Add current segment progress
                        overallProgress += closestPoint.progress * currentPathSegments[activeSegmentIndex].length;
                        
                        // Convert to 0-1 range
                        overallProgress /= tracingPathObj.getTotalLength();
                        
                        // Update the visible tracing
                        updateTracingProgress(overallProgress);
                    }
                }
            }
            
            // Continue tracing
            function continueTracing(e) {
                if (activeSegmentIndex >= currentPathSegments.length) {
                    return; // All segments completed
                }
                
                const [x, y] = getCoordinates(e);
                
                // Only proceed if we're on or near the path
                if (isPointOnPath(x, y)) {
                    drawingCanvas.style.cursor = 'pointer';
                    
                    // Get closest point on current segment
                    const closestPoint = getClosestPointOnCurrentSegment(x, y);
                    
                    if (closestPoint) {
                        // Calculate overall progress based on active segment and point progress
                        let overallProgress = 0;
                        
                        // Add completed segments
                        for (let i = 0; i < activeSegmentIndex; i++) {
                            overallProgress += currentPathSegments[i].length;
                        }
                        
                        // Add current segment progress
                        overallProgress += closestPoint.progress * currentPathSegments[activeSegmentIndex].length;
                        
                        // Convert to 0-1 range
                        overallProgress /= tracingPathObj.getTotalLength();
                        
                        // Update the visible tracing
                        updateTracingProgress(overallProgress);
                        
                        // Check if we've completed this segment
                        if (closestPoint.progress > 0.95) {
                            activeSegmentIndex++;
                            
                            // If we've completed all segments, show success
                            if (activeSegmentIndex >= currentPathSegments.length) {
                                console.log('Letter completed!');
                            }
                        }
                    }
                } else {
                    drawingCanvas.style.cursor = 'default';
                }
            }
            
            // Get coordinates for both mouse and touch events
            function getCoordinates(e) {
                let x, y;
                
                if (e.type.includes('mouse')) {
                    const rect = drawingCanvas.getBoundingClientRect();
                    x = e.clientX - rect.left;
                    y = e.clientY - rect.top;
                } else {
                    // Touch event
                    const rect = drawingCanvas.getBoundingClientRect();
                    x = e.touches[0].clientX - rect.left;
                    y = e.touches[0].clientY - rect.top;
                }
                
                return [x, y];
            }
            
            // Event listeners for mouse
            drawingCanvas.addEventListener('mousedown', startTracing);
            drawingCanvas.addEventListener('mousemove', continueTracing);
            
            // Event listeners for touch devices
            drawingCanvas.addEventListener('touchstart', function(e) {
                e.preventDefault(); // Prevent scrolling
                startTracing(e);
            });
            
            drawingCanvas.addEventListener('touchmove', function(e) {
                e.preventDefault(); // Prevent scrolling
                continueTracing(e);
            });
            
            // Letter selection change
            letterSelect.addEventListener('change', function() {
                drawLetter(this.value);
            });
            
            // Clear button
            clearButton.addEventListener('click', function() {
                drawLetter(letterSelect.value);
            });
            
            // Initial letter
            drawLetter(letterSelect.value);
            
            // Font loading check - removed as it's not needed anymore
            document.fonts.ready.then(function() {
                fontMessage.style.display = 'none';
                // Initial letter drawing (done above, no need to do it again)
            });
        });
    </script>
</body>
</html>
